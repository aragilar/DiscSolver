version: 2.1

orbs:
  tox_orb:
    jobs:
      tox_job:
        parameters:
          tox_name:
            type: string
            default: py37
          sundials_version:
            type: string
            default: 4.1.0
          tox_args:
            type: string
            default: --
        environment:
          SUNDIALS_VERSION: <<parameters.sundials_version>>
        executor: tox_exec
        steps:
          - tox_pre
          - tox_install
          - tox_run:
              tox_name: <<parameters.tox_name>>
              tox_args: <<parameters.tox_args>>
          - tox_post
    commands:
      tox_pre:
        steps:
          - checkout
          - restore_cache:
              keys:
              - sundials-
          - restore_cache:
              keys:
              - pip-
          - run: pwd
          - run: env
      tox_install:
        steps:
          - run: sudo apt-get update
          - run: sudo apt-get install cmake gfortran liblapack-dev libgirepository1.0-dev libgtk-3-dev
          - run: sudo pip install -U pip setuptools wheel
          - run: sudo pip install -c known_broken_constraints.txt --pre -U coverage # coverage major versions need to match
          - run: sudo pip install -U tox codecov
      tox_run:
        parameters:
          tox_name:
            type: string
            default: py37
          tox_args:
            type: string
            default: --
        steps:
          - run:
              no_output_timeout: 1.5h
              environment:
                BASH_ENV: ./ci_support/ensure_sundials_installed.sh
              command: tox -e <<parameters.tox_name>> <<parameters.tox_args>>

      tox_post:
        steps:
          - run: codecov
          - save_cache:
              key: sundials-{{ epoch}}
              paths:
                - /home/circleci/sundials
          - save_cache:
              key: pip-{{ epoch}}
              paths:
                - /home/circleci/.cache/pip

    executors:
      tox_exec:
        parameters:
          version:
            type: string
            default: "3.7"
        docker:
          - image: circleci/python:<<parameters.version>>

workflows:
  version: 2
  commit:
    jobs:
      - tox_orb/tox_job:
          name: py37
          tox_name: py37
          tox_args: -- -n 2
      - tox_orb/tox_job:
          name: flake8
          tox_name: flake8
      - tox_orb/tox_job:
          name: pylint
          tox_name: pylint
      - tox_orb/tox_job:
          name: check-manifest
          tox_name: check-manifest
      - tox_orb/tox_job:
          name: checkreadme
          tox_name: checkreadme

  nightly:
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - master
    jobs:
      - tox_orb/tox_job:
          name: py37
          tox_name: py37
          tox_args: -- -n 2
      - tox_orb/tox_job:
          name: flake8
          tox_name: flake8
      - tox_orb/tox_job:
          name: pylint
          tox_name: pylint
      - tox_orb/tox_job:
          name: check-manifest
          tox_name: check-manifest
      - tox_orb/tox_job:
          name: checkreadme
          tox_name: checkreadme
